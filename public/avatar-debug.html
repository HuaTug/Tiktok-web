<!DOCTYPE html>
<html>
<head>
    <title>å¤´åƒè°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .avatar-test { margin: 10px 0; }
        img { max-width: 100px; max-height: 100px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>ğŸ” å¤´åƒè°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. æµ‹è¯•å¤´åƒURL</h2>
        <div id="url-test"></div>
        <input type="text" id="avatar-url" placeholder="è¾“å…¥å¤´åƒURLæµ‹è¯•" style="width: 500px;">
        <button onclick="testAvatarUrl()">æµ‹è¯•</button>
        <div id="test-result"></div>
    </div>

    <div class="debug-section">
        <h2>2. å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
        <div id="user-info"></div>
        <button onclick="getUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
    </div>

    <div class="debug-section">
        <h2>3. TokençŠ¶æ€</h2>
        <div id="token-info"></div>
        <button onclick="checkToken()">æ£€æŸ¥Token</button>
    </div>

    <script>
        // é»˜è®¤å¤´åƒURL
        const defaultAvatarUrl = 'http://localhost:9002/tiktok-avatarurl/tiktok.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=tiktok_minio_admin%2F20260121%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20260121T070102Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=fb1c7c486e1074c8f317c8644479ea01e04c36fa47e8bccd0a6524ce781a8bd6';

        function init() {
            console.log('ğŸ”§ [AVATAR-DEBUG] åˆå§‹åŒ–è°ƒè¯•å·¥å…·')
            document.getElementById('avatar-url').value = defaultAvatarUrl;
            checkToken();
            getUserInfo();
        }

        function testAvatarUrl() {
            const url = document.getElementById('avatar-url').value;
            const resultDiv = document.getElementById('test-result');
            
            console.log('ğŸ” [AVATAR-DEBUG] æµ‹è¯•å¤´åƒURL:', url);
            resultDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';
            
            // åˆ›å»ºå›¾ç‰‡æµ‹è¯•
            const img = new Image();
            img.onload = function() {
                console.log('âœ… [AVATAR-DEBUG] å¤´åƒåŠ è½½æˆåŠŸ:', url);
                resultDiv.innerHTML = `
                    <div class="success">âœ… å¤´åƒåŠ è½½æˆåŠŸ</div>
                    <div class="avatar-test">
                        <img src="${url}" alt="æµ‹è¯•å¤´åƒ">
                        <p>å°ºå¯¸: ${this.naturalWidth}x${this.naturalHeight}</p>
                    </div>
                `;
            };
            
            img.onerror = function(e) {
                console.error('âŒ [AVATAR-DEBUG] å¤´åƒåŠ è½½å¤±è´¥:', url, e);
                resultDiv.innerHTML = `
                    <div class="error">âŒ å¤´åƒåŠ è½½å¤±è´¥</div>
                    <p>é”™è¯¯: ${e}</p>
                    <p>URL: ${url}</p>
                `;
            };
            
            img.src = url;
        }

        function getUserInfo() {
            console.log('ğŸ‘¤ [AVATAR-DEBUG] è·å–ç”¨æˆ·ä¿¡æ¯...');
            
            fetch('http://localhost:8888/v1/user/get', {
                headers: {
                    'Access-Token': getToken()
                }
            })
            .then(res => res.json())
            .then(data => {
                console.log('ğŸ“¥ [AVATAR-DEBUG] ç”¨æˆ·ä¿¡æ¯å“åº”:', data);
                const userDiv = document.getElementById('user-info');
                
                if (data.code === 10000) {
                    const userData = data.data?.User || data.data?.user || data.data;
                    userDiv.innerHTML = `
                        <div class="success">âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ</div>
                        <p><strong>ç”¨æˆ·ID:</strong> ${userData?.user_id || 'N/A'}</p>
                        <p><strong>ç”¨æˆ·å:</strong> ${userData?.user_name || 'N/A'}</p>
                        <p><strong>å¤´åƒURL:</strong> ${userData?.avatar_url || 'N/A'}</p>
                        <p><strong>å¤´åƒ:</strong> ${userData?.avatar || 'N/A'}</p>
                        <div class="avatar-test">
                            <img src="${userData?.avatar_url || userData?.avatar || ''}" alt="ç”¨æˆ·å¤´åƒ">
                        </div>
                    `;
                } else {
                    userDiv.innerHTML = `<div class="error">âŒ è·å–å¤±è´¥: ${data.message}</div>`;
                }
            })
            .catch(err => {
                console.error('âŒ [AVATAR-DEBUG] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                document.getElementById('user-info').innerHTML = `<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${err.message}</div>`;
            });
        }

        function getToken() {
            // å°è¯•ä»localStorageè·å–token
            const token = localStorage.getItem('token') || localStorage.getItem('tokenX');
            if (token) {
                try {
                    const parsed = JSON.parse(token);
                    return parsed.token || parsed;
                } catch {
                    return token;
                }
            }
            return null;
        }

        function checkToken() {
            const token = getToken();
            const tokenDiv = document.getElementById('token-info');
            
            if (token) {
                console.log('âœ… [AVATAR-DEBUG] æ‰¾åˆ°Token:', token.substring(0, 50) + '...');
                tokenDiv.innerHTML = `
                    <div class="success">âœ… æ‰¾åˆ°Token</div>
                    <p><strong>Tokenå‰ç¼€:</strong> ${token.substring(0, 20)}...</p>
                    <p><strong>Tokené•¿åº¦:</strong> ${token.length}</p>
                `;
            } else {
                console.warn('âŒ [AVATAR-DEBUG] æœªæ‰¾åˆ°Token');
                tokenDiv.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°Token</div>';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>